<div class="header">
  <h1>Lista de Pacientes</h1>

  <!-- CORS Warning Message -->
  <div *ngIf="showCorsMessage" class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Conectividad limitada:</strong> No se puede conectar directamente al servidor debido a políticas CORS. 
    Mostrando datos de ejemplo. 
    <button type="button" class="btn btn-sm btn-outline-primary ms-2" (click)="retryApiConnection()">
      <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
    </button>
    <button type="button" class="btn-close" (click)="dismissCorsMessage()"></button>
  </div>

  <div class="d-flex align-items-center flex-wrap gap-3 mt-3 justify-content-end">
    <div class="input-group" style="width: 300px;">
      <span class="input-group-text bg-white border-end-0">
        <i class="bi bi-search"></i>
      </span>
      <input
        type="text"
        class="form-control border-start-0"
        placeholder="Buscar por DNI"
        (keyup)="applyFilter($event)">
    </div>

    <div class="input-group" style="width: 260px;">
      <span class="input-group-text bg-white border-end-0">
        <i class="bi bi-ui-checks"></i>
      </span>
      <select class="form-select border-start-0" [(ngModel)]="tipoServicio">
        <option value="">Tipo de servicio</option>
        <option value="emergencia">Emergencia</option>
        <option value="hospitalizacion">Hospitalización</option>
        <option value="consulta_externa">Consulta externa</option>
      </select>
    </div>
  </div>
</div>

<!-- Loading indicator -->
<div *ngIf="isLoading" class="d-flex justify-content-center align-items-center my-4">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <span class="ms-2">Cargando pacientes...</span>
</div>

<div class="table-container" [class.d-none]="isLoading">
  <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z1">
    <ng-container matColumnDef="dni">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>DNI</th>
      <td mat-cell *matCellDef="let paciente">{{paciente.dni}}</td>
    </ng-container>

    <ng-container matColumnDef="nombre">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
      <td mat-cell *matCellDef="let paciente">{{paciente.nombre}}</td>
    </ng-container>

    <ng-container matColumnDef="edad">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Edad</th>
      <td mat-cell *matCellDef="let paciente">{{paciente.edad}} años</td>
    </ng-container>

    <ng-container matColumnDef="fecha">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
      <td mat-cell *matCellDef="let paciente">{{paciente.fecha}}</td>
    </ng-container>

    <ng-container matColumnDef="hora">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Hora</th>
      <td mat-cell *matCellDef="let paciente">{{paciente.hora}}</td>
    </ng-container>

    <ng-container matColumnDef="ubicacion">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Ubicación</th>
      <td mat-cell *matCellDef="let paciente">
        <mat-chip color="primary" selected>{{paciente.ubicacion}}</mat-chip>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row 
      *matRowDef="let row; columns: displayedColumns;"
      (click)="selectPatient(row)"
      class="patient-row"
      [class.selected]="selectedPaciente?.dni === row.dni">
  </tr>
  </table>

  <mat-paginator [pageSize]="pageSize"
                 [pageSizeOptions]="[5, 10, 20, 50]"
                 [hidePageSize]="true"
                 [showFirstLastButtons]="true"
                 [length]="totalRecords"
                 aria-label="Seleccionar página">
  </mat-paginator>

</div>

<!-- Sección de acciones del paciente seleccionado - Rediseñada con botones arriba -->
<div *ngIf="selectedPaciente" class="patient-actions-container mt-4">
  
  <!-- Botones de acción - Arriba del formulario alineados a la derecha con tamaño normal -->
  <div class="d-flex justify-content-end gap-3 mb-4">
    <button type="button" class="btn btn-custom px-3" (click)="interconsulta()">
      <i class="bi bi-arrow-left-right me-2"></i>
      Interconsulta
    </button>
    
    <button type="button" class="btn btn-custom px-3" (click)="visualizar()">
      <i class="bi bi-eye me-2"></i>
      Visualizar
    </button>
    
    <button type="button" class="btn btn-custom px-3" (click)="agregar()">
      <i class="bi bi-plus-circle me-2"></i>
      Agregar
    </button>
    
    <button type="button" class="btn btn-close-custom" (click)="cerrarAcciones()">
      <i class="bi bi-x-circle me-2"></i>
      Cerrar
    </button>
  </div>
  
  <!-- Información del paciente seleccionado -->
  <div class="card mb-4">
    <div class="card-body">
      <!-- Primera fila: Estado Actual, DNI, Serv. Responsable, Prof. Responsable -->
      <div class="row">
        <div class="col-md-2">
          <label class="form-label text-muted">Estado Actual</label>
          <select class="form-select">
            <option>Hospitalización</option>
            <option>Emergencia</option>
            <option>Consulta Externa</option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label text-muted">DNI</label>
          <input type="text" class="form-control" [value]="selectedPaciente.dni" readonly>
        </div>
        
        <div class="col-md-2">
          <label class="form-label text-muted">Serv. Responsable</label>
          <input type="text" class="form-control" value="Psiquiatría" readonly>
        </div>
        
        <div class="col-md-3">
          <label class="form-label text-muted">Prof. Responsable</label>
          <input type="text" class="form-control" value="Jaime Huerta" readonly>
        </div>
      </div>
      
      <!-- Segunda fila: Fecha ingreso (Desde/Hasta), Nombre (Ap. Paterno/Ap. Materno), Sexo (Edad/Religión) -->
      <div class="row mt-3">
        <div class="col-md-4">
          <label class="form-label text-muted">Fecha ingreso</label>
          <div>
            <div class="mb-2">
              <label class="form-label small">Desde:</label>
              <input type="text" class="form-control" [value]="selectedPaciente.fecha" readonly>
            </div>
            <div>
              <label class="form-label small">Hasta:</label>
              <input type="text" class="form-control" [value]="selectedPaciente.fecha" readonly>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <label class="form-label text-muted">Nombre</label>
          <input type="text" class="form-control mb-2" [value]="selectedPaciente.nombre" readonly>
          
          <div class="d-flex gap-2">
            <div class="flex-fill">
              <label class="form-label small">Ap. Paterno:</label>
              <input type="text" class="form-control" value="Alvarez" readonly>
            </div>
            <div class="flex-fill">
              <label class="form-label small">Ap. Materno:</label>
              <input type="text" class="form-control" value="Jimenez" readonly>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <label class="form-label text-muted">Sexo</label>
          <input type="text" class="form-control mb-2" value="Masculino" readonly>
          
          <div class="d-flex gap-2">
            <div class="flex-fill">
              <label class="form-label small">Edad:</label>
              <input type="text" class="form-control" [value]="selectedPaciente.edad" readonly>
            </div>
            <div class="flex-fill">
              <label class="form-label small">Religión:</label>
              <input type="text" class="form-control" value="Católica" readonly>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
</div>

<!-- Modal de Interconsulta -->
<div *ngIf="showInterconsultaModal" class="modal-overlay" (click)="closeInterconsultaModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <!-- Header del modal -->
    <div class="modal-header">
      <h3 class="modal-title">Interconsulta</h3>
      <button type="button" class="btn-close-modal" (click)="closeInterconsultaModal()">
        <i class="bi bi-x-circle"></i>
      </button>
    </div>

    <!-- Body del modal -->
    <div class="modal-body">
      
      <p class="modal-subtitle">Seleccione especialidad...</p>
      
      <!-- Selector de especialidad -->
      <div class="form-group mb-3">
        <select class="form-select-modal" [(ngModel)]="interconsultaData.especialidad">
          <option value="Pediatría">Pediatría</option>
          <option value="Psiquiatría">Psiquiatría</option>
          <option value="Neurología">Neurología</option>
          <option value="Cardiología">Cardiología</option>
          <option value="Traumatología">Traumatología</option>
        </select>
      </div>

    </div>

    <!-- Footer del modal -->
    <div class="modal-footer">
      <button type="button" class="btn btn-continue" (click)="continueInterconsulta()">
        Continuar
      </button>
    </div>

  </div>
</div>

<!-- Modal de Agregar - NUEVO -->
<div *ngIf="showAgregarModal" class="modal-overlay" (click)="closeAgregarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <!-- Header del modal -->
    <div class="modal-header">
      <h3 class="modal-title">Agregar Documento</h3>
      <button type="button" class="btn-close-modal" (click)="closeAgregarModal()">
        <i class="bi bi-x-circle"></i>
      </button>
    </div>

    <!-- Body del modal -->
    <div class="modal-body">
      
      <p class="modal-subtitle">Seleccione tipo de documento...</p>
      
      <!-- Selector de tipo de documento -->
      <div class="form-group mb-3">
        <select class="form-select-modal" [(ngModel)]="agregarData.tipoDocumento">
          <option value="Historia Clínica">Historia Clínica</option>
          <option value="Examen Físico">Examen Físico</option>
          <option value="Evolución">Evolución</option>
          <option value="Receta Médica">Receta Médica</option>
          <option value="Notas de enfermería">Notas de enfermería</option>
        </select>
      </div>

    </div>

    <!-- Footer del modal -->
    <div class="modal-footer">
      <button type="button" class="btn btn-continue" (click)="continueAgregar()">
        Continuar
      </button>
    </div>

